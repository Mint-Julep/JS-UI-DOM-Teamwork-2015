<!doctype html>
<html lang="en">
<head>

</head>
<body>
<input type="text" name="user" value="hacko">
<input type="text" name="pass" value="hackob">
<input type="button" id="log-in" value="Log in">
<input type="button" id="register" value="Register">
<span id="response">No response from server</span>
<canvas id="canvas" width="500" height="500" style="border:1px solid black; display:block;"></canvas>
<script src="/assets/js/jquery-1.11.3.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
    var socket = io.connect('https://bombgunner-hackohackob.c9.io/');

    var currentX = 20,
            currentY = 20,
            speedIncrease=3;

    var currentSpeed = {
        x:0,
        y:0
    };
    var pressedKeys = {
        down:false,
        up:false,
        left:false,
        right:false
    }

    socket.on('connect', function (data) {
        socket.emit('join', 'User connected');
    });

    $('#log-in').on('click', function () {
        socket.emit('log-in', {
            name: $('input[name="user"]').val(),
            pass: $('input[name="pass"]').val()
        });
    });

    $('#register').on('click', function () {
        socket.emit('register', {
            name: $('input[name="user"]').val(),
            pass: $('input[name="pass"]').val()
        });
    });

    var canvas = document.getElementById('canvas').getContext('2d');
    $('#canvas').on('click', function (e) {
        canvas.fillStyle="#b04";
        canvas.fillRect(e.offsetX, e.offsetY, 5, 5);
        canvas.fillStyle="#000";
        socket.emit('canvas', {
            x: e.offsetX,
            y: e.offsetY
        });
    });

    $(document).keydown(function(e){
        var newX=currentX
                ,newY=currentY;

        if(e.which == 97 || e.which == 65) {
            //left pressed
//            currentSpeed.x=-5;
            pressedKeys.left=true;
        } else if(e.which == 100 || e.which == 68){
             //right pressed
//            currentSpeed.x=+5;
            pressedKeys.right=true;
        }else if(e.which == 83 || e.which == 68){
            //down pressed
//            currentSpeed.y=+5;
            pressedKeys.down=true;
        } else if(e.which == 87 || e.which == 68){
            //up pressed
//            currentSpeed.y-=2;
//            currentSpeed.y=-5;
            pressedKeys.up=true;
        }
    });

    $(document).keyup(function(e){
        if(e.which == 97 || e.which == 65) {
            pressedKeys.left=false;
        } else if(e.which == 100 || e.which == 68){
            pressedKeys.right=false;
        }else if(e.which == 83 || e.which == 68){
            pressedKeys.down=false;
        } else if(e.which == 87 || e.which == 68){
            pressedKeys.up=false;
        }
    });

    setInterval(function(){

        redrawPlayer();
        checkPressedKeys();
    } ,40);

    function checkPressedKeys(){
        if(pressedKeys.left){
            currentSpeed.x=-speedIncrease;
        }else{
            currentSpeed.x=reduceSpeed(currentSpeed.x)
        }

        if(pressedKeys.right){
            currentSpeed.x=+speedIncrease;
        }else{
            currentSpeed.x=reduceSpeed(currentSpeed.x)
        }

        if(pressedKeys.down){
            currentSpeed.y=+speedIncrease;
        }else{
            currentSpeed.y=reduceSpeed(currentSpeed.y)
        }

        if(pressedKeys.up){
            currentSpeed.y=-speedIncrease;
        }else{
            currentSpeed.y=reduceSpeed(currentSpeed.y)
        }
    }


    function redrawPlayer(){
//        console.log('redrawing player');
        var newX=currentX
                ,newY=currentY;

        canvas.clearRect(currentX,currentY,5,5);
        newX+=currentSpeed.x;
        newY+=currentSpeed.y;
        canvas.fillStyle="#0f4";
        canvas.fillRect(newX,newY,5,5);
        canvas.fillStyle="#000";

        var movingObject={
            oldX:currentX,
            oldY:currentY,
            newX:newX,
            newY:newY
        };

        socket.emit('playerMoved',movingObject);

        currentX=newX;
        currentY=newY;
    }

    function reduceSpeed(speed){
        if(speed!==0){
            if(speed>0){
                speed--;
                if(speed<0){
                    speed=0;
                }
            }else if(speed<0){
                speed++;
                if(speed>0){
                    speed=0;
                }
            }
        }

        return speed;
    }

    socket.on('canvas', function (data) {
        canvas.fillStyle="#b04";
        canvas.fillRect(data.x, data.y, 5, 5);
        canvas.fillStyle="#000";
    });
    
    socket.on('messages', function (data) {
        $('#response').html(data.toString());
    });

    socket.on('playerMoved', function (data) {
        canvas.clearRect(data.oldX,data.oldY,5,5);
        canvas.fillStyle="#000";
        canvas.fillRect(data.newX,data.newY,5,5);
    });
</script>
</body>
</html>  
